<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>转化分析编辑</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet"
          type="text/css"/>
    <link rel="stylesheet"
          th:href="@{/metronic/assets/global/plugins/font-awesome/css/font-awesome.min.css}">
    <link th:href="@{/metronic/assets/global/plugins/simple-line-icons/simple-line-icons.min.css}"
          rel="stylesheet"
          type="text/css"/>
    <link th:href="@{/metronic/assets/global/plugins/bootstrap/css/bootstrap.min.css}" rel="stylesheet"
          type="text/css"/>
    <link th:href="@{/metronic/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css}"
          rel="stylesheet"
          type="text/css"/>
    <link th:href="@{/metronic/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.css}"
          rel="stylesheet"
          type="text/css"/>
    <link th:href="@{/metronic/assets/global/plugins/bootstrap-select/css/bootstrap-select.css}" rel="stylesheet"/>
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link th:href="@{/metronic/assets/global/css/components-md.min.css}" rel="stylesheet"
          id="style_components"
          type="text/css"/>
    <link th:href="@{/metronic/assets/global/css/plugins-md.min.css}" rel="stylesheet" type="text/css"/>
    <!-- END THEME GLOBAL STYLES -->
    <!-- BEGIN THEME LAYOUT STYLES -->
    <link th:href="@{/metronic/assets/layouts/layout3/css/layout.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/metronic/assets/layouts/layout3/css/themes/default.min.css}" rel="stylesheet"
          type="text/css"
          id="style_color"/>
    <link th:href="@{/metronic/assets/layouts/layout3/css/custom.min.css}" rel="stylesheet" type="text/css"/>
    <link th:href="@{/querybuilder/dist/css/query-builder.default.min.css}"
          rel="stylesheet"
          type="text/css"/>
    <link rel="shortcut icon" href="favicon.ico"/>
</head>
<!-- END HEAD -->

<body class="page-container-bg-solid page-md">
<div class="page-wrapper">
    <div th:replace="common/header :: header"></div>
    <div class="page-wrapper-row full-height">
        <div class="page-wrapper-middle">
            <!-- BEGIN CONTAINER -->
            <div class="page-container">
                <!-- BEGIN CONTENT -->
                <div class="page-content-wrapper">
                    <!-- BEGIN CONTENT BODY -->
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <div class="container">
                            <!-- BEGIN PAGE TITLE -->
                            <div class="page-title">
                                <h1>数据洞察
                                    <small>转化分析编辑</small>
                                </h1>
                            </div>
                            <!-- END PAGE TITLE -->
                        </div>
                    </div>
                    <!-- END PAGE HEAD-->
                    <!-- BEGIN PAGE CONTENT BODY -->
                    <div class="page-content">
                        <div class="container">
                            <!-- BEGIN PAGE CONTENT INNER -->
                            <div class="page-content-inner">
                                <div class="mt-content-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="portlet light bordered">
                                                <div class="portlet-title">
                                                    <div class="caption">
                                                        <span class="caption-subject  bold uppercase">编辑转化分析模型</span>
                                                    </div>
                                                    <div class="tools">
                                                        <a href="" class="collapse" data-original-title=""
                                                           title=""> </a>
                                                    </div>
                                                </div>
                                                <div class="portlet-body form form-horizontal">
                                                    <!-- BEGIN FORM-->
                                                    <div class="form-body" id="app-container">
                                                        <h3 class="form-section">基础信息</h3>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label col-md-3">转化名称</label>
                                                                    <div class="col-md-9">
                                                                        <input id="funnelName" type="text"
                                                                               class="form-control"
                                                                               th:value="${funnel.funnelName}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!--/span-->
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label col-md-3">所属渠道</label>
                                                                    <div class="col-md-9">
                                                                        <select id="channelSelect"
                                                                                class="bs-select form-control">
                                                                            <option th:each="channel:${channelList}"
                                                                                    th:value="${channel.id}"
                                                                                    th:text="${channel.channelName}">
                                                                            </option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!--/span-->
                                                        </div>
                                                        <!--/row-->
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="form-group">
                                                                    <label class="control-label col-md-3">描述</label>
                                                                    <div class="col-md-9">
                                                                            <textarea id="funnelDesc"
                                                                                      class="form-control"
                                                                                      rows="3"></textarea>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <!--/span-->
                                                        </div>
                                                        <!--/row-->
                                                        <h3 class="form-section">转化路径</h3>
                                                        <!--/row-->
                                                        <div class="row">
                                                            <div class="col-md-12">
                                                                <table id="funnelSteps"
                                                                       class="table table-hover table-light">
                                                                    <thead>
                                                                    <tr class="uppercase">
                                                                        <th> #</th>
                                                                        <th> 名称</th>
                                                                        <th> 事件</th>
                                                                        <th> 过滤器</th>
                                                                        <th> 操作</th>
                                                                    </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                            <div class="col-md-12">
                                                                <div class="form-group">
                                                                    <div class="col-md-12">
                                                                        <button id="addStepBtn" type="button"
                                                                                class="btn green mt-ladda-btn btn-sm ladda-button btn-circle"
                                                                                data-style="slide-down">
                                                                            <span class="ladda-label">新增步骤</span>
                                                                            <span class="ladda-spinner"></span>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-actions">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="row">
                                                                    <div class="col-md-offset-3 col-md-9">
                                                                        <button id="saveFunnel" class="btn green">
                                                                            保存
                                                                        </button>
                                                                        <button type="button" class="btn default">
                                                                            上一步
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6"></div>
                                                        </div>
                                                    </div>
                                                    <!-- END FORM-->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- END PAGE CONTENT INNER -->
                        </div>
                    </div>
                    <!-- END PAGE CONTENT BODY -->
                    <!-- END CONTENT BODY -->
                </div>
                <!-- END CONTENT -->
            </div>
            <!-- END CONTAINER -->
        </div>
    </div>
    <div th:replace="common/footer :: footer"></div>
</div>
<!-- BEGIN CORE PLUGINS -->


<script th:src="@{/metronic/assets/global/plugins/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/bootstrap/js/bootstrap.min.js}"
        type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/js.cookie.min.js}" type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js}"
        type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/jquery.blockui.min.js}" type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js}"
        type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/scripts/app.min.js}" type="text/javascript"></script>
<!-- END CORE PLUGINS -->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script th:src="@{/metronic/assets/global/plugins/moment.min.js}" type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/bootstrap-daterangepicker/daterangepicker.min.js}"
        type="text/javascript"></script>
<script th:src="@{/metronic/assets/global/plugins/bootstrap-select/js/bootstrap-select.min.js}"
        type="text/javascript"></script>
<script th:src="@{/querybuilder/dist/js/query-builder.standalone.js}"
        type="text/javascript"></script>
<script th:src="@{/querybuilder/dist/i18n/query-builder.zh-CN.js}" type="text/javascript"></script>
<script th:src="@{/echarts/echarts.min.js}" type="text/javascript"></script>
<script>
    /*<![CDATA[*/
    $(document).ready(function () {
        $("select").selectpicker();
        $("#channelSelect").val([[${message}]]);
        


        initEvents();
        $("#channelSelect").change(function () {
            initEvents();
        });
        $("#addStepBtn").click(function () {
            addFunnelStep();
        });

        $("#saveFunnel").click(function () {
            var formData = {};
            formData.funnelName = $("#funnelName").val();
            formData.channelId = $("#channelSelect").val();
            formData.funnelDesc = $("#funnelDesc").val();
            var details = [];
            $("#funnelSteps > tbody > tr").each(function () {
                var sql = null;
                var dsl = null;
                var sortNum = parseInt($(this).children().first().text());
                var eventId = $(this).children().eq(2).children().first().val();
                var stepName = $(this).children().eq(1).children().first().val();
                if ($(this).data("querybuilderObj").queryBuilder('getSQL') != null) {
                    sql = $(this).data("querybuilderObj").queryBuilder('getSQL').sql;
                    dsl = JSON.stringify($(this).data("querybuilderObj").queryBuilder('getRules'));
                }
                details.push({
                    'eventId': eventId,
                    'filterDsl': dsl,
                    'filter': sql,
                    'sortNum': sortNum,
                    'stepName': stepName
                });
            });

            $.post('/insight/saveFunnel', {
                'funnelName': formData.funnelName,
                'channelId': formData.channelId,
                'funnelDesc': formData.funnelDesc,
                'funnelDetailJson': JSON.stringify(details)
            }, function (data) {
                if (data.code == '0') {
                    alert('保存成功');
                } else {
                    alert('保存失败');
                }
            }, 'json');


        });

        // $(document).on("change", "#funnelSteps > tbody > tr > td:eq(1) > select", function () {
        //     var querybuildDivTd = $(this).parent().next();
        //     querybuildDivTd.empty();
        //     alert("aaaaa");
        // });
        $(document).on("click", "a[removeSteps]", function () {
            $(this).parent().parent().remove();
        });
    });

    var formBody = {
        channelId: $("#channelSelect").val(),
        events: [],
    };

    function initEvents() {
        $("#funnelSteps > tbody").empty();
        $.get('/scene/getEventsByChannelId', {'channelId': $("#channelSelect").val()}, function (data) {
            formBody.events = data;
            formBody.channelId = $("#channelSelect").val();

        }, 'json');
    }


    function addFunnelStep() {
        var eventSelectOptionsTag = "";
        for (var i = 0; i < formBody.events.length; i++) {
            eventSelectOptionsTag = eventSelectOptionsTag + '<option value=' + formBody.events[i].id + '>' + formBody.events[i].eventLable + '</option>';
        }
        var indexText = $("#funnelSteps > tbody > tr:last > td:eq(0)").text();
        var index = 0;
        if (indexText != '') {
            index = parseInt(indexText);
        }
        var funnelStepTag = "<tr>" +
            "<td>" + (index + 1) + "</td>" +
            "<td><input /></td>" +
            "<td><select>" + eventSelectOptionsTag + "</select></td>" +
            "<td><div></div></td>" +
            "<td><a removeSteps='removeSteps' class='btn btn-sm red'><i class='fa fa-times'></i> 删除 </a></td>" +
            "</tr>";
        $("#funnelSteps > tbody").append(funnelStepTag);
        initFilters($("#funnelSteps > tbody > tr:last > td:eq(3)"));
    }


    function initFilters(pNode) {
        pNode.empty();
        pNode.append("<div></div>");
        $.get('/scene/getFilterByChannelIdInEvent', {'channelId': formBody.channelId}, function (data) {
            var querybuilderObj = pNode.children().first().queryBuilder({
                filters: data
            });
            pNode.parent().data("querybuilderObj", querybuilderObj);
        }, 'json');
    }

    /*]]>*/
</script>
</body>

</html>